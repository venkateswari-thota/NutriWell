import React, { useEffect, useState } from 'react';
import { Modal, Pressable, View, Text, FlatList, SafeAreaView, ScrollView, Image, StyleSheet, TouchableOpacity, ImageBackground, Dimensions } from 'react-native';
import { Ionicons, MaterialIcons, FontAwesome5, Entypo } from '@expo/vector-icons';
import { useRouter } from 'expo-router';
import { PieChart } from 'react-native-chart-kit';
import * as Progress from 'react-native-progress';
import { useUser } from "../context/authContext"; 
import img from "../assets/images/blue_green.jpeg";
import AsyncStorage from '@react-native-async-storage/async-storage';

const dietPlans = [
  {
    title: 'Scan or Upload',
    description: 'Instantly analyze meals by scanning them live or uploading',
    backgroundColor: '#EDA345',
    image: require('../assets/images/food_upload.png'),
  },
  {
    title: 'Smart Food Detection',
    description: 'Identify food items using intelligent image recognition',
    backgroundColor: '#B0C8FF',
    image: require('../assets/images/food.png'),
  },
  {
    title: 'Personalized Diet Plans',
    description: 'Get the perfect diet plan based on your food habits and health goals',
    backgroundColor: 'pink',
    image: require('../assets/images/diet_planning.png'),
  },
  {
    title: 'Nutritional Breakdown',
    description: 'Dive into your meal‚Äôs calories, macros, and nutrients.',
    backgroundColor: '#A7FFAF',
    image: require('../assets/images/nutritional.png'),
  },
  {
    title: 'Fitness Suggestions',
    description: 'Receive workout recommendations that match your fitness level',
    backgroundColor: '#EDA345',
    image: require('../assets/images/fitness.png'),
  },
  {
    title: 'Health Tips & Remedies',
    description: 'Daily health tips and simple home remedies to keep you energized and in balance',
    backgroundColor: '#B0C8FF',
    image: require('../assets/images/tips.png'),
  },
  {
    title: 'Progress Tracking',
    description: 'Monitor your diet and fitness journey with easy-to-read progress visuals and reminders',
    backgroundColor: 'pink',
    image: require('../assets/images/progress.png'),
  },
  {
    title: 'AI Chat Assistant',
    description: 'Chat with our smart assistant for diet advice, health queries, or fitness tips ‚Äî anytime',
    backgroundColor: '#D4B8F5',
    image: require('../assets/images/robo.png'),
  },
];




const DietCard = ({ title, description, backgroundColor, image, isImageRight }) => {
  const textAlignStyle = isImageRight ? { paddingRight: 80 } : { paddingLeft: 80 };
  const imageStyle = isImageRight ? { right: -30, bottom: -30 } : { left: -30, bottom: -30 };

  return (
    <View style={styles.cardWrapper}>
      <View style={[styles.card, { backgroundColor }]}>
        <View style={[styles.cardContent, textAlignStyle]}>
          <Text style={styles.cardTitle}>{title}</Text>
          <Text style={styles.cardDescription}>{description}</Text>
        </View>
        <Image source={image} style={[styles.cardImage, imageStyle]} />
      </View>
    </View>
  );
};

export default function NutriWellHomeScreen() {

    console.log("in dashaboard")
    const router = useRouter();
    const [visible, setVisible] = useState(false);
    const [dailyTotals, setDailyTotals] = useState({
      calories: 0,
      carbs: 0,
      protein: 0,
      fat: 0
    });
    const [weeklyTotals, setWeeklyTotals] = useState({
      calories: 0,
      carbs: 0,
      protein: 0,
      fat: 0
    });

    const [userId, setUserId] = useState(null)
    // useEffect(() => {
    //   console.log("User from context in Dashboard:", user);
    // }, [user]);
    
    // const { user, logout } = useUser();
    // const [localUser, setLocalUser] = useState(user);
    // useEffect(() => {
    //   if (!user) {
    //     AsyncStorage.getItem("user")
    //       .then(storedUser => {
    //         if (storedUser) {
    //           const parsedUser = JSON.parse(storedUser);
    //           console.log("Retrieved user from AsyncStorage in Dashboard:", parsedUser);
    //           setLocalUser(parsedUser);
    //           // Optionally, update context by calling login(parsedUser);
    //         }
    //       })
    //       .catch(err => console.error("Error retrieving user:", err));
    //   } else {
    //     setLocalUser(user);
    //   }
    // }, [user]);
    
    // console.log("user from dashboard",user);
    // console.log("id from dashbaord",user?.user?._id)
    
    
    // useEffect(() => {
    //   if (user?.user?._id) {
    //     console.log("use effect id from dashbaord",user?.user?._id)
    //     fetchDailyTotals(); // Your existing daily fetch
    //     fetchWeeklyTotals(); // New weekly fetch
    //   }
    // }, [user]);

    useEffect(() => {
      const fetchData = async () => {
        const stored = await AsyncStorage.getItem("user");
        if (stored) {
          const parsed = JSON.parse(stored);
          console.log("user if from dashboard",parsed?.user?._id);
          setUserId(parsed?.user?._id);
          fetchDailyTotals(parsed?.user?._id);
          fetchWeeklyTotals(parsed?.user?._id);
        }
      };
      fetchData();
    }, []);
   
    // Fetch daily totals when component mounts
      const fetchDailyTotals = async () => {
        try {
          const response = await fetch(`http://192.168.132.131:5000/api/details/${userId}/daily-totals`);
          const data = await response.json();
          if (data.totals) {
            setDailyTotals(data.totals);
          }
        } catch (error) {
          console.error('Error fetching daily totals:', error);
        }
      };
      const fetchWeeklyTotals = async () => {
        try {
          const response = await fetch(`http://192.168.132.131:5000/api/details/${userId}/weekly-totals`);
          const data = await response.json();
          if (data.weeklyTotals) {
            setWeeklyTotals(data.weeklyTotals);
          }
        } catch (error) {
          console.error('Error fetching weekly totals:', error);
        }
      };

      
    

    // Calculate percentages for pie chart
    const totalMacronutrients = dailyTotals.carbs + dailyTotals.protein + dailyTotals.fat;
    const carbsPercentage = totalMacronutrients > 0 ? (dailyTotals.carbs / totalMacronutrients) * 100 : 0;
    const proteinPercentage = totalMacronutrients > 0 ? (dailyTotals.protein / totalMacronutrients) * 100 : 0;
    const fatPercentage = totalMacronutrients > 0 ? (dailyTotals.fat / totalMacronutrients) * 100 : 0;

    // Daily calorie goal (adjust as needed)
    const dailyCalorieGoal = 2500;
    const handleLogout = async () => {
      logout();
    };

    return (
      <ImageBackground source={img} style={styles.background} resizeMode="cover">
        <SafeAreaView style={styles.container}>
          <ScrollView contentContainerStyle={styles.scrollContent}>
            {/* Header */}
            <View style={styles.header}>
              <TouchableOpacity onPress={() => setVisible(!visible)} style={styles.profileCircle}>
                <Ionicons name="person-circle-outline" size={36} color="green" />
              </TouchableOpacity>

              {visible && (
                <Modal
                  animationType="fade"
                  transparent={true}
                  visible={visible}
                  onRequestClose={() => setVisible(false)}
                >
                  <Pressable style={styles.modalOverlay} onPress={() => setVisible(false)}>
                    <View style={styles.modalContainer}>
                      <View style={styles.profileRow}>
                        <Ionicons name="person-circle-outline" size={50} color="#333" />
                        <View style={{ marginLeft: 10 }}>
                          <Text style={styles.username}>{user?.user?.fullName || 'User'}</Text>
                          <Text style={styles.email}>{user?.user?.email || ''}</Text>
                        </View>
                      </View>
                      <View style={styles.buttonRow}>
                        <TouchableOpacity style={styles.button}>
                          <Text style={styles.buttonText} onPress={() => router.push('/editDetails')}>Edit details</Text>
                        </TouchableOpacity>
                        <TouchableOpacity style={styles.button} onPress={handleLogout}>
                          <Text style={styles.buttonText}>Logout</Text>
                        </TouchableOpacity>
                      </View>
                    </View>
                  </Pressable>
                </Modal>
              )}

              <Text style={styles.appTitle}>NutriWell</Text>
              <View style={[styles.notificationCircle, { backgroundColor: '#e0e0e0' }]}>
                <Ionicons name="notifications-outline" size={22} color="green" />
              </View>
            </View>

            {user ? (
              <Text style={styles.welcome}>Welcome, {user?.user?.fullName}</Text>
            ) : (
              <Text style={styles.welcome}>Welcome, Guest</Text>
            )}

            {/* Today Card */}
            <View style={styles.card}>
              <Text style={styles.cardTitle}>Today</Text>
              <Text style={styles.label}>Calories</Text>
              <Text style={styles.value}>{dailyTotals.calories} / {dailyCalorieGoal} Cal</Text>
            </View>

            <Text style={styles.cardTitle}>Nutrients</Text>
            <PieChart
              data={[
                {
                  name: 'Carbs',
                  population: dailyTotals.carbs,
                  color: '#3498db',
                  legendFontColor: '#7F7F7F',
                  legendFontSize: 12,
                  legendLabel: `Carbs ‚Ä¢ ${carbsPercentage.toFixed(1)}%`,
                },
                {
                  name: 'Proteins',
                  population: dailyTotals.protein,
                  color: '#2ecc71',
                  legendFontColor: '#7F7F7F',
                  legendFontSize: 12,
                  legendLabel: `Proteins ‚Ä¢ ${proteinPercentage.toFixed(1)}%`,
                },
                {
                  name: 'Fats',
                  population: dailyTotals.fat,
                  color: '#f1c40f',
                  legendFontColor: '#7F7F7F',
                  legendFontSize: 12,
                  legendLabel: `Fats ‚Ä¢ ${fatPercentage.toFixed(1)}%`,
                },
              ]}
              width={Dimensions.get('window').width - 32}
              height={200}
              chartConfig={{
                backgroundColor: '#fff',
                backgroundGradientFrom: '#fff',
                backgroundGradientTo: '#fff',
                color: (opacity = 1) => `rgba(0, 0, 0, ${opacity})`,
              }}
              accessor="population"
              backgroundColor="transparent"
              paddingLeft="15"
            />

            {/* Weekly Calories */}
            {/* Weekly Calories */}
<View style={styles.card}>
  <Text style={styles.cardTitle}>Weekly</Text>
  <Text style={styles.label}>Calories</Text>
  <Text style={styles.value}>{weeklyTotals.calories} / {2500*7} KCal</Text>
</View>

            {/* Macronutrients */}
           {/* Weekly Macronutrients */}
<View style={styles.card}>
  <Text style={styles.cardTitle}>Weekly Macronutrients</Text>
  <View style={styles.nutrientStatsRow}>
    <View style={styles.nutrientStat}>
      <Text style={styles.statLabel}>Carbs</Text>
      <Progress.Circle
        size={80}
        progress={weeklyTotals.carbs / (300*7)} // Weekly goal (300g daily * 7 days)
        showsText={true}
        formatText={() => `${weeklyTotals.carbs}g`}
        color="#F6C445"
        thickness={8}
        borderWidth={0}
        unfilledColor="#f2f2f2"
      />
    </View>
    <View style={styles.nutrientStat}>
      <Text style={styles.statLabel}>Protein</Text>
      <Progress.Circle
        size={80}
        progress={weeklyTotals.protein / (150*7)} // Weekly goal (150g daily * 7 days)
        showsText={true}
        formatText={() => `${weeklyTotals.protein}g`}
        color="#FF6A5C"
        thickness={8}
        borderWidth={0}
        unfilledColor="#f2f2f2"
      />
    </View>
    <View style={styles.nutrientStat}>
      <Text style={styles.statLabel}>Fat</Text>
      <Progress.Circle
        size={80}
        progress={weeklyTotals.fat / (80*7)} // Weekly goal (80g daily * 7 days)
        showsText={true}
        formatText={() => `${weeklyTotals.fat}g`}
        color="#82B1FF"
        thickness={8}
        borderWidth={0}
        unfilledColor="#f2f2f2"
      />
    </View>
  </View>
</View>

            <Text style={styles.headerText}>Eat Well Live Well</Text>
            <FlatList
              data={dietPlans}
              keyExtractor={(item) => item.title}
              renderItem={({ item, index }) => (
                <DietCard
                  title={item.title}
                  description={item.description}
                  backgroundColor={item.backgroundColor}
                  image={item.image}
                  isImageRight={index % 2 === 1}
                />
              )}
              contentContainerStyle={{ paddingBottom: 30 }}
            />
          </ScrollView>

          {/* Bottom Navigation Bar */}
          <View style={styles.navbar}>
            <TouchableOpacity style={styles.navItem} onPress={() => router.push('/dashboard')}>
              <Ionicons name="home-outline" size={22} />
              <Text style={styles.navLabel}>Dashboard</Text>
            </TouchableOpacity>
            <TouchableOpacity style={styles.navItem} onPress={() => router.push('/tracking')}>
              <MaterialIcons name="insights" size={22} />
              <Text style={styles.navLabel}>Tracking</Text>
            </TouchableOpacity>
            <TouchableOpacity style={styles.navItemCenter} onPress={() => router.push('/logfood')}>
              <Entypo name="plus" size={22} />
            </TouchableOpacity>
            <TouchableOpacity style={styles.navItem} onPress={() => router.push('/fitness')}>
              <FontAwesome5 name="dumbbell" size={20} />
              <Text style={styles.navLabel}>Fitness</Text>
            </TouchableOpacity>
            <TouchableOpacity style={styles.navItem} onPress={() => router.push('/chatbot')}>
              <Ionicons name="chatbubbles-outline" size={22} />
              <Text style={styles.navLabel}>Chatbot</Text>
            </TouchableOpacity>
          </View>
        </SafeAreaView>
      </ImageBackground>
    );
}

// ... keep all your existing styles ...

// Styles remain exactly the same
const styles = StyleSheet.create({
  background: {
    flex: 1,
  },
  modalOverlay: {
  flex: 1,
  backgroundColor: 'rgba(0,0,0,0.4)',
  justifyContent: 'left',
  alignItems: 'left',
},
modalContainer: {
  width: 300,
  backgroundColor: 'white',
  borderRadius: 15,
  padding: 20,
  marginTop:60,
  marginLeft:20,
  shadowColor: '#000',
  shadowOffset: { width: 1, height: 2 },
  shadowOpacity: 0.3,
  shadowRadius: 4,
  elevation: 10,
},

  topIcon: {
    position: 'absolute',
    top: 10,
    left: 20,
    zIndex: 10,
  },
  popupCard: {
    position: 'absolute',
    top: 60,
    left: 20,
    width: 300,
    backgroundColor: 'white',
    borderRadius: 15,
    padding: 15,
    shadowColor: '#000',
    shadowOffset: { width: 1, height: 2 },
    shadowOpacity: 0.3,
    shadowRadius: 4,
    elevation: 5,
    zIndex: 9,
  },
  profileRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 15,
  },
  username: {
    fontSize: 18,
    fontWeight: '600',
  },
  email: {
    fontSize: 14,
    color: '#555',
  },
  buttonRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  button: {
    borderWidth: 1,
    borderColor: '#333',
    borderRadius: 8,
    paddingVertical: 8,
    paddingHorizontal: 12,
  },
  buttonText: {
    fontSize: 14,
    color: '#333',
  },
  scrollContent: {
    padding: 16,
    paddingBottom: 10,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  profileCircle: {
    backgroundColor: '#e0e0e0',
    borderRadius: 20,
    width: 40,
    height: 40,
    justifyContent: 'center',
    alignItems: 'center',
  },
 
 appTitle: {
  fontSize: 24,
  fontWeight: 'bold',
  color: 'green',
  textShadowColor: 'white',
  textShadowOffset: { width: 1, height: 1 },
  textShadowRadius: 1,
},
notificationCircle: {
  width: 40,
  height: 40,
  borderRadius: 20,
  justifyContent: 'center',
  alignItems: 'center',
},

  welcome: {
    fontSize: 18,
    marginVertical: 12,
    fontWeight: '500',
    marginLeft:10,
    marginTop:20,
  },
  card: {
    backgroundColor: 'rgba(255, 255, 255, 0.8)', 
    padding: 10,
    marginLeft:10,
    borderRadius: 16,
    shadowColor: '#000',
    shadowOpacity: 0.05,
    shadowRadius: 1,
    elevation: 2,
    marginBottom: 12,
  },
  cardTitle: {
    fontSize: 18,
    fontWeight: '600',
    marginBottom: 10,
  },
label: {
    fontSize: 14,
    color: '#888',
  },
  value: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#222',
  },
  nutrientRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  nutrientItem: {
    fontSize: 15,
    marginVertical: 2,
  },
  piechart: {
    width: 180,
    height: 180,
    resizeMode: 'contain',
  },
  nutrientStatsRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 8,
  },
  nutrientStat: {
    alignItems: 'center',
  },
statLabel: {
    fontSize: 14,
    fontWeight: '600',
    marginBottom: 4,
  },
  statCircle: {
    backgroundColor: '#e0e0e0',
    width: 50,
    height: 50,
    borderRadius: 25,
    justifyContent: 'center',
    alignItems: 'center',
  },
  statText: {
    fontWeight: '600',
  },
  navbar: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    paddingVertical: 10,
    paddingHorizontal: 12,
    backgroundColor: '#fff',
    borderTopWidth: 0.5,
    borderTopColor: '#ccc',
    position: 'absolute',
    bottom: 0,
    width: '100%',
  },
  navItem: {
    alignItems: 'center',
  },
navItemCenter: {
    backgroundColor: '#e0e0e0',
    width: 44,
    height: 44,
    borderRadius: 22,
    justifyContent: 'center',
    alignItems: 'center',
    marginTop: -20,
  },
  navLabel: {
    fontSize: 12,
    marginTop: 2,
  },

  container: {
    flex: 1,
    backgroundColor: '#E8F4F8',
    padding: 16,
  },
  headerText: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#1D2D5F',
    marginBottom: 16,
    textAlign: 'center',
    marginTop:20,
  },
  cardWrapper: {
    marginBottom: 40,
    alignItems: 'center',
  },
  card: {
    width: '100%',
    borderRadius: 20,
    padding: 20,
    elevation: 3,
    shadowColor: '#000',
    shadowOpacity: 0.1,
    shadowOffset: { width: 0, height: 2 },
    overflow: 'visible',
    position: 'relative',
  },
  cardContent: {
    zIndex: 1,
  },
  cardTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#1D2D5F',
  },
  cardDescription: {
    fontSize: 14,
    color: '#333',
    marginTop: 6,
  },
  cardImage: {
    width: 130,
    height: 130,
    resizeMode: 'contain',
    position: 'absolute',
    zIndex: 0,
    opacity: 0.9,
  },
});


//logfood.jsx
import React, { useState, useEffect } from "react";
import {
  View,
  Text,
  StyleSheet,
  Image,
  TouchableOpacity,
  ImageBackground,
  Platform,
  ScrollView,
  KeyboardAvoidingView,
} from "react-native";
import * as ImagePicker from "expo-image-picker";
import { useRouter } from "expo-router";
import { StatusBar } from "expo-status-bar";
import { Ionicons } from "@expo/vector-icons";
import * as Progress from "react-native-progress";
import * as FileSystem from "expo-file-system";
import AsyncStorage from "@react-native-async-storage/async-storage";
import { useUser } from "../context/authContext"; 

const SnapMeal = () => {
  const [image, setImage] = useState(null);
  const [submitted, setSubmitted] = useState(false);
  const [summary, setSummary] = useState("");
  const [carbs, setCarbs] = useState(0);
  const [protein, setProtein] = useState(0);
  const [fat, setFat] = useState(0);
  const maxNutrient = 100;
  const [userId, setUserId] = useState(null);


  const router = useRouter();
  const { user } = useUser();
  
  useEffect(() => {
    setUserId(user?.user?._id); // or user?._id depending on your context shape
  }, [user]);
  
  
  const uploadImageToBackend = async (uri) => {
    try {
      const base64 = await FileSystem.readAsStringAsync(uri, {
        encoding: FileSystem.EncodingType.Base64,
      });
      // fetchUserId();
      // console.log("user id and image are",userId);
      // const userId = new mongoose.Types.ObjectId(userId);
      // console.log("user id and image are",userId);
      console.log("user if from log-food to backend",userId);

      const response = await fetch("http://192.168.132.131:5000/api/details/upload-image", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: userId, // Replace with dynamic user ID if needed
          base64Image: base64,
        }),
      });
     
     
      const data = await response.json();
      if (!response.ok) throw new Error(data.error || "Upload failed");

      setSummary(data.food.summary || "No summary returned");

      const [totalCalories, carbsVal, proteinVal, fatVal] =
        (data.food.calorieInfo || "0, 0, 0, 0")
          .split(",")
          .map((x) => parseInt(x.trim()));

      setCarbs(carbsVal);
      setProtein(proteinVal);
      setFat(fatVal);
    } catch (err) {
      console.error("‚ùå Error uploading image:", err);
      setSummary("Failed to analyze the image. Please try again.");
    }
  };

  const pickImage = async () => {
    const permission = await ImagePicker.requestMediaLibraryPermissionsAsync();
    if (!permission.granted) {
      alert("Permission to access gallery is required!");
      return;
    }

    const result = await ImagePicker.launchImageLibraryAsync({
      allowsEditing: true,
      quality: 1,
    });

    if (!result.canceled) {
      const uri = result.assets[0].uri;
      setImage(uri);
      setSubmitted(true);
      uploadImageToBackend(uri);
    }
  };

  const captureImage = async () => {
    const permission = await ImagePicker.requestCameraPermissionsAsync();
    if (!permission.granted) {
      alert("Permission to access camera is required!");
      return;
    }

    const result = await ImagePicker.launchCameraAsync({
      allowsEditing: true,
      quality: 1,
    });

    if (!result.canceled) {
      const uri = result.assets[0].uri;
      setImage(uri);
      setSubmitted(true);
      uploadImageToBackend(uri);
    }
  };

  const goBack = () => {
    setImage(null);
    setSubmitted(false);
    setSummary("");
    setCarbs(0);
    setProtein(0);
    setFat(0);
  };

  const goToDashboard = () => {
    router.push("/dashboard");
  };
  const fetchUserId = async () => {
    try {
      const storedId = await AsyncStorage.getItem("userId");
      
      if (storedId) {
        setUserId(storedId);
        console.log("Retrieved userId:", storedId);
      } else {
        console.warn("No userId found in AsyncStorage.");
      }
    } catch (error) {
      console.error("Error retrieving userId:", error);
    }
  };

  
  return (
    <KeyboardAvoidingView style={{ flex: 1 }} behavior="padding" enabled>
      <ImageBackground
        source={require("../assets/images/background.jpg")}
        style={styles.backgroundd}
        resizeMode="cover"
      >
        <StatusBar style="light" />
        <View style={styles.overlay}>
          <TouchableOpacity onPress={goToDashboard} style={styles.universalBackButton}>
            <Ionicons name="home" size={24} color="#fff" />
          </TouchableOpacity>

          {submitted && (
            <TouchableOpacity onPress={goBack} style={styles.backButton}>
              <Ionicons name="arrow-back" size={24} color="#fff" />
              <Text style={styles.backText}>Back</Text>
            </TouchableOpacity>
          )}

          {!submitted ? (
            <>
              <Text style={styles.heading}>Snap Your{"\n"}Meal Before{"\n"}You Dig In</Text>
              <View style={styles.previewContainer}>
                {image ? (
                  <Image source={{ uri: image }} style={styles.previewImage} />
                ) : (
                  <View style={styles.placeholder}>
                    <Ionicons name="image-outline" size={48} color="#aaa" />
                  </View>
                )}
              </View>

              <View style={styles.buttonRow}>
                <TouchableOpacity style={styles.button} onPress={pickImage}>
                  <Ionicons name="images-outline" size={20} color="#fff" />
                  <Text style={styles.buttonText}>Upload from{"\n"}Gallery</Text>
                </TouchableOpacity>

                <TouchableOpacity style={styles.button} onPress={captureImage}>
                  <Ionicons name="camera-outline" size={20} color="#fff" />
                  <Text style={styles.buttonText}>Log{"\n"}Food</Text>
                </TouchableOpacity>
              </View>
            </>
          ) : (
            <ScrollView style={{ flex: 1 }}>
              <View style={styles.contentContainer}>
                <View style={styles.card}>
                  <Text style={styles.cardTitle}>Macronutrients</Text>
                  <View style={styles.nutrientStatsRow}>
                    <View style={styles.nutrientStat}>
                      <Text style={styles.statLabel}>Carbs</Text>
                      <Progress.Circle
                        size={80}
                        progress={carbs / maxNutrient}
                        showsText
                        formatText={() => `${carbs}g`}
                        color="#F6C445"
                        thickness={8}
                        borderWidth={0}
                        unfilledColor="#f2f2f2"
                      />
                    </View>
                    <View style={styles.nutrientStat}>
                      <Text style={styles.statLabel}>Protein</Text>
                      <Progress.Circle
                        size={80}
                        progress={protein / maxNutrient}
                        showsText
                        formatText={() => `${protein}g`}
                        color="#FF6A5C"
                        thickness={8}
                        borderWidth={0}
                        unfilledColor="#f2f2f2"
                      />
                    </View>
                    <View style={styles.nutrientStat}>
                      <Text style={styles.statLabel}>Fat</Text>
                      <Progress.Circle
                        size={80}
                        progress={fat / maxNutrient}
                        showsText
                        formatText={() => `${fat}g`}
                        color="#82B1FF"
                        thickness={8}
                        borderWidth={0}
                        unfilledColor="#f2f2f2"
                      />
                    </View>
                  </View>
                </View>

                <View style={styles.summarySection}>
                  <Text style={styles.summaryHeading}>Summary</Text>
                  <Text style={styles.summaryText}>{summary}</Text>
                </View>
              </View>
            </ScrollView>
          )}
        </View>
      </ImageBackground>
    </KeyboardAvoidingView>
  );
};




const styles = StyleSheet.create({
  backgroundd: {
    flex: 1,
    width: "100%",
    height: "100%",
  },
  overlay: {
    flex: 1,
    backgroundColor: "rgba(0,0,0,0.3)",
    padding: 20,
    justifyContent: "space-between",
    paddingBottom: 30,
  },
  heading: {
    color: "#fff",
    fontSize: 31,
    fontWeight: "bold",
    marginTop: 50,
  },
  previewContainer: {
    height: 250,
    borderRadius: 20,
    borderWidth: 2,
    borderColor: "#fff",
    justifyContent: "center",
    alignItems: "center",
    overflow: "hidden",
    backgroundColor: "#00000040",
  },
  previewImage: {
    width: "100%",
    height: "100%",
    resizeMode: "cover",
  },
  placeholder: {
    justifyContent: "center",
    alignItems: "center",
  },
  buttonRow: {
    flexDirection: "row",
    justifyContent: "space-around",
  },
  button: {
    backgroundColor: "#ff6600",
    paddingVertical: 15,
    paddingHorizontal: 20,
    borderRadius: 12,
    alignItems: "center",
    width: "45%",
  },
  buttonText: {
    color: "#fff",
    fontWeight: "bold",
    textAlign: "center",
    fontSize: 14,
    marginTop: 5,
  },
  backButton: {
    flexDirection: "row",
    alignItems: "center",
    marginTop: Platform.OS === "ios" ? 50 : 30,
    marginBottom: 10,
  },
  backText: {
    color: "#fff",
    marginLeft: 5,
    fontSize: 16,
  },
  universalBackButton: {
    position: "absolute",
    top: 40,
    left: 20,
    zIndex: 10,
  },
  card: {
    marginTop: 20,
    padding: 15,
    backgroundColor: "#fff",
    borderRadius: 10,
    shadowColor: "#000",
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 5,
  },
  cardTitle: {
    fontSize: 18,
    fontWeight: "bold",
    marginBottom: 10,
    color: "#333",
  },
  nutrientStatsRow: {
    flexDirection: "row",
    justifyContent: "space-evenly",
  },
  nutrientStat: {
    alignItems: "center",
  },
  statLabel: {
    fontSize: 14,
    marginBottom: 5,
    color: "#333",
  },
  summarySection: {
    marginTop: 30,
    padding: 15,
    backgroundColor: "#fff",
    borderRadius: 10,
    shadowColor: "#000",
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 5,
  },
  summaryHeading: {
    fontSize: 18,
    fontWeight: "bold",
    marginBottom: 10,
    color: "#333",
  },
  summaryText: {
    fontSize: 14,
    color: "#555",
  },
});

export default SnapMeal;


// OnboardingFormApp.js
import React, { useState } from 'react';
import { useRouter } from 'expo-router';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useUser } from "../context/authContext"; 

import {
  View, Text, TextInput, TouchableOpacity, StyleSheet,
  ScrollView, Alert, FlatList, Modal
} from 'react-native';

const indianStates = [
  'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa',
  'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka', 'Kerala',
  'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland',
  'Odisha', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura',
  'Uttar Pradesh', 'Uttarakhand', 'West Bengal', 'Delhi'
];

export default function details() {
  const [page, setPage] = useState(1);
  const [name, setName] = useState('');
  const [gender, setGender] = useState('');
  const [age, setAge] = useState('');
  const [height, setHeight] = useState('');
  const [weight, setWeight] = useState('');
  const [state, setState] = useState('');
  const [sleepHours, setSleepHours] = useState('');
  const [healthIssue, setHealthIssue] = useState('');
  const [healthIssuesList, setHealthIssuesList] = useState([]);
  const [errors, setErrors] = useState({});
  const [modalVisible, setModalVisible] = useState(false);
    const { user } = useUser();
    const [userId,setUserId] = useState(null);
     useEffect(() => {
        setUserId(user?.user?._id); // or user?._id depending on your context shape
      }, [user]);

  const validatePage1 = () => {
    const newErrors = {};
    if (!name.trim()) newErrors.name = true;
    if (!gender) newErrors.gender = true;
    const ageNum = parseInt(age);
    if (!ageNum || ageNum <= 0) newErrors.age = true;
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const validatePage2 = () => {
    const newErrors = {};
    if (!height || isNaN(height)) newErrors.height = true;
    if (!weight || isNaN(weight)) newErrors.weight = true;
    if (!state) newErrors.state = true;
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const validatePage3 = () => {
    const newErrors = {};
    if (!sleepHours || isNaN(sleepHours)) newErrors.sleepHours = true;
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const nextPage = () => {
    if (page === 1 && validatePage1()) setPage(2);
    else if (page === 2 && validatePage2()) setPage(3);
  };

  const prevPage = () => {
    if (page > 1) setPage(page - 1);
  };

  // const submit = () => {
  //   if (validatePage3()) {
  //     // Alert.alert('Submitted', 'Your details are locked successsfully!');
  //     Alert.alert('Chomp Chomp!', 'Data digested. You‚Äôre on the wellness express ü•ëüöÇ');

  //   }
  // };
  const submit = async () => {
    if (!validatePage3()) return;
  
    try {
      //const userId = await AsyncStorage.getItem('userId');
 // Retrieve the userId from localStorage
  
      if (!userId) {
        Alert.alert("Error", "User not logged in");
        return;
      }
  
      const userData = {
        userId,  // Use the dynamic userId from localStorage
        name,
        gender,
        age,
        height,
        weight,
        state,
        sleepHours,
        healthIssues: healthIssuesList,
      };
  
      const response = await fetch('http://192.168.132.131:5000/api/details/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData),
      });
  
      const result = await response.json();
  
      if (response.ok) {
        //Alert.alert("Success", result.message);
        Alert.alert('Chomp Chomp!', 'Data digested. You‚Äôre on the wellness express ü•ëüöÇ');
      } else {
        Alert.alert("Error", result.message || "Something went wrong");
      }
    } catch (error) {
      Alert.alert("Error", "Failed to connect to server: " + error.message);
    }
  };
  
  const addHealthIssue = () => {
    if (healthIssue.trim()) {
      setHealthIssuesList([...healthIssuesList, healthIssue.trim()]);
      setHealthIssue('');
    }
  };

  const renderProgress = () => (
    <View style={styles.progressBar}>
      {[1, 2, 3].map(i => (
        <View key={i} style={[styles.bar, page >= i && styles.barActive]} />
      ))}
    </View>
  );

  
const router = useRouter();

const handleNext = () => {
  if (page === 1 && validatePage1()) {
    setPage(2);
  } else if (page === 2 && validatePage2()) {
    setPage(3);
  } else if (page === 3 && validatePage3()) {
    submit();  // Trigger form submission
    setTimeout(() => router.replace('/Intro'), 1000); // 1-second delay
    //router.replace('/dashboard');  // Redirect after successful validation
  }
};


  const renderPicker = () => (
    <>
      <TouchableOpacity
        style={[styles.pickerButton, errors.state && styles.inputError]}
        onPress={() => setModalVisible(true)}
      >
        <Text>{state || 'Select a state'}</Text>
      </TouchableOpacity>

      <Modal visible={modalVisible} transparent animationType="slide">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <FlatList
              data={indianStates}
              keyExtractor={(item, index) => index.toString()}
              renderItem={({ item }) => (
                <TouchableOpacity
                  style={styles.modalItem}
                  onPress={() => {
                    setState(item);
                    setModalVisible(false);
                  }}
                >
                  <Text>{item}</Text>
                </TouchableOpacity>
              )}
            />
            <TouchableOpacity
              onPress={() => setModalVisible(false)}
              style={{ padding: 10, alignSelf: 'center' }}
            >
              <Text style={{ color: 'red' }}>Cancel</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>
    </>
  );

  return (
    <View contentContainerStyle={styles.container}>
      {renderProgress()}

      {page === 1 && (
        <View style={styles.page}>
          <Text style={styles.label}>Name:</Text>
          <TextInput
            style={[styles.input, errors.name && styles.inputError]}
            value={name}
            onChangeText={setName}
          />
          <Text style={styles.note}>Let us know what we should call you.</Text>

          <Text style={styles.label}>Gender:</Text>
          <View style={styles.genderRow}>
            <TouchableOpacity
              style={[styles.genderBtn, gender === 'Male' && styles.selected]}
              onPress={() => setGender('Male')}
            >
              <Text>Male</Text>
            </TouchableOpacity>
            <TouchableOpacity
              style={[styles.genderBtn, gender === 'Female' && styles.selected]}
              onPress={() => setGender('Female')}
            >
              <Text>Female</Text>
            </TouchableOpacity>
          </View>
          <Text style={styles.note}>We use sex at birth and age to calculate an accurate goal for you.</Text>

          <Text style={styles.label}>Age:</Text>
          <TextInput
            style={[styles.input, errors.age && styles.inputError]}
            keyboardType='numeric'
            value={age}
            onChangeText={setAge}
          />
          <Text style={styles.note}>How old are you?</Text>
        </View>
      )}

      {page === 2 && (
        <View style={styles.page}>
          <Text style={styles.label}>Height (cm):</Text>
          <TextInput
            style={[styles.input, errors.height && styles.inputError]}
            keyboardType='numeric'
            value={height}
            onChangeText={setHeight}
          />
          <Text style={styles.note}>Knowing your height helps personalize your experience.</Text>

          <Text style={styles.label}>Weight (kg):</Text>
          <TextInput
            style={[styles.input, errors.weight && styles.inputError]}
            keyboardType='numeric'
            value={weight}
            onChangeText={setWeight}
          />
          <Text style={styles.note}>Used for BMI and calorie calculations.</Text>

          <Text style={styles.label}>Where do you live:</Text>
          <Text style={styles.note}>Choose your current location to tailor health insights.</Text>
          {renderPicker()}
        </View>
      )}

      {page === 3 && (
        <View style={styles.page}>
          <Text style={styles.label}>Sleep Hours:</Text>
          <TextInput
            style={[styles.input, errors.sleepHours && styles.inputError]}
            keyboardType='numeric'
            value={sleepHours}
            onChangeText={setSleepHours}
          />
          <Text style={styles.note}>Good sleep impacts your overall health and energy.</Text>

          <Text style={styles.label}>Health Issues:</Text>
          <Text style={styles.note}>Let us know any health issues to personalize your plan.</Text>
          <View style={styles.healthInputRow}>
            <TextInput
              style={[styles.input, { flex: 1 }]}
              value={healthIssue}
              onChangeText={setHealthIssue}
              placeholder='Enter issue'
            />
            <TouchableOpacity style={styles.addButton} onPress={addHealthIssue}>
              <Text style={{ color: 'white', fontWeight: 'bold' }}>Add</Text>
            </TouchableOpacity>
          </View>
          <FlatList
            data={healthIssuesList}
            keyExtractor={(item, index) => index.toString()}
            renderItem={({ item }) => <Text style={styles.issueItem}>{item}</Text>}
          />
        </View>
      )}

      <View style={styles.navRow}>
        {page > 1 && (
          <TouchableOpacity style={styles.backButton} onPress={prevPage}>
            <Text style={{ fontSize: 18, color:"#fff" }}>‚Üê </Text>
          </TouchableOpacity>
        )}
        <TouchableOpacity style={styles.button} onPress={handleNext}>
          <Text style={styles.buttonText}>{page < 3 ? 'Next' : 'Submit'}</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: { padding: 20, paddingTop: 50 },
  progressBar: { flexDirection: 'row', justifyContent: 'center', marginBottom: 20 },
  bar: { width: 100, height: 5, backgroundColor: '#ddd', marginHorizontal: 5, borderRadius: 5 },
  barActive: { backgroundColor: 'green' },
  page: { marginBottom: 150 },
  label: { fontSize: 20, fontWeight: 'bold', marginTop: 40 },
  note: { color: 'rgba(0, 0, 0, 0.4)', fontSize: 12, marginTop: 4 },
  input: { borderWidth: 1, borderColor: '#ccc', borderRadius: 6, padding: 10, marginTop: 10 },
  inputError: { borderColor: 'red' },
  genderRow: { flexDirection: 'row', marginTop: 10 },
  genderBtn: { padding: 10, borderWidth: 1, borderColor: '#ccc', borderRadius: 6, marginRight: 10 },
  selected: { backgroundColor: '#e0ffe0', borderColor: 'green' },
  navRow: { flexDirection: 'row', justifyContent: 'space-between', marginTop: 40 },
  button: { backgroundColor: 'green', padding: 10, borderRadius: 6, position: 'absolute', right: 0 },
  buttonText: { color: 'white', fontWeight: 'bold' },
  backButton: { justifyContent: 'center' },
  pickerButton: {
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 6,
    padding: 12,
    marginTop: 10
  },
  modalOverlay: {
    flex: 1,
    justifyContent: 'center',
    backgroundColor: 'rgba(0,0,0,0.4)'
  },
  modalContent: {
    backgroundColor: 'white',
    margin: 50,
    borderRadius: 8,
    padding: 40,
    maxHeight: '80%'
  },
  modalItem: {
    padding: 20,
    borderBottomWidth: 1,
    borderBottomColor: '#eee'
  },
  healthInputRow: { flexDirection: 'row', alignItems: 'center', marginTop: 10 },
  addButton: { backgroundColor: 'green', padding: 10, marginLeft: 10, borderRadius: 6 },
  issueItem: { padding: 5, backgroundColor: '#e6ffe6', borderRadius: 4, marginVertical: 2 }
});



// OnboardingFormApp.js
import React, { useState , useEffect} from 'react';
import { useRouter } from 'expo-router';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useUser } from "../context/authContext"; 

import {
  View, Text, TextInput, TouchableOpacity, StyleSheet,
  ScrollView, Alert, FlatList, Modal
} from 'react-native';

const indianStates = [
  'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa',
  'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka', 'Kerala',
  'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland',
  'Odisha', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura',
  'Uttar Pradesh', 'Uttarakhand', 'West Bengal', 'Delhi'
];

export default function editDetails() {
  const [page, setPage] = useState(1);
  const [name, setName] = useState('');
  const [gender, setGender] = useState('');
  const [age, setAge] = useState('');
  const [height, setHeight] = useState('');
  const [weight, setWeight] = useState('');
  const [state, setState] = useState('');
  const [sleepHours, setSleepHours] = useState('');
  const [healthIssue, setHealthIssue] = useState('');
  const [healthIssuesList, setHealthIssuesList] = useState([]);
  const [errors, setErrors] = useState({});
  const [modalVisible, setModalVisible] = useState(false);
  const { user } = useUser();
   const [userId, setUserId] = useState(null);

  const validatePage1 = () => {
    const newErrors = {};
    if (!name.trim()) newErrors.name = true;
    if (!gender) newErrors.gender = true;
    const ageNum = parseInt(age);
    if (!ageNum || ageNum <= 0) newErrors.age = true;
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const validatePage2 = () => {
    const newErrors = {};
    if (!height || isNaN(height)) newErrors.height = true;
    if (!weight || isNaN(weight)) newErrors.weight = true;
    if (!state) newErrors.state = true;
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const validatePage3 = () => {
    const newErrors = {};
    if (!sleepHours || isNaN(sleepHours)) newErrors.sleepHours = true;
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const nextPage = () => {
    if (page === 1 && validatePage1()) setPage(2);
    else if (page === 2 && validatePage2()) setPage(3);
  };

  const prevPage = () => {
    if (page > 1) setPage(page - 1);
  };

  // const submit = () => {
  //   if (validatePage3()) {
  //     // Alert.alert('Submitted', 'Your details are locked successsfully!');
  //     Alert.alert('Chomp Chomp!', 'Data digested. You‚Äôre on the wellness express ü•ëüöÇ');

  //   }
  // };


  const submit = async () => {
    if (!validatePage3()) return;
  
    try {
      //const userId = await AsyncStorage.getItem('userId');
 // Retrieve the userId from localStorage
  
      if (!userId) {
        Alert.alert("Error", "User not logged in");
        return;
      }
  
      const userData = {
        userId,  // Use the dynamic userId from localStorage
        name,
        gender,
        age,
        height,
        weight,
        state,
        sleepHours,
        healthIssues: healthIssuesList,
      };
  
      const response = await fetch('http://192.168.132.131:5000/api/details/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData),
      });
  
      const result = await response.json();
  
      if (response.ok) {
        //Alert.alert("Success", result.message);
        Alert.alert('Chomp Chomp!', 'Data digested. You‚Äôre on the wellness express ü•ëüöÇ');
      } else {
        Alert.alert("Error", result.message || "Something went wrong");
      }
    } catch (error) {
      Alert.alert("Error", "Failed to connect to server: " + error.message);
    }
  };
  
  const addHealthIssue = () => {
    if (healthIssue.trim()) {
      setHealthIssuesList([...healthIssuesList, healthIssue.trim()]);
      setHealthIssue('');
    }
  };

  const renderProgress = () => (
    <View style={styles.progressBar}>
      {[1, 2, 3].map(i => (
        <View key={i} style={[styles.bar, page >= i && styles.barActive]} />
      ))}
    </View>
  );

  
const router = useRouter();

const handleNext = () => {
  if (page === 1 && validatePage1()) {
    setPage(2);
  } else if (page === 2 && validatePage2()) {
    setPage(3);
  } else if (page === 3 && validatePage3()) {
    submit();  // Trigger form submission
    setTimeout(() => router.replace('/Intro'), 1000); // 1-second delay
    //router.replace('/dashboard');  // Redirect after successful validation
  }
};

  
  
  useEffect(() => {
    setUserId(user?.user?._id); // or user?._id depending on your context shape
  }, [user]);
  
useEffect(() => {
  const fetchUserDetails = async () => {
    try {
      // const storedUserId = await AsyncStorage.getItem('userId');
      // if (!storedUserId) return;

      const response = await fetch(`http://192.168.132.131:5000/api/details/${userId}/edit-details`);
      const data = await response.json();

      if (response.ok) {
        setName(data.name || '');
        setGender(data.gender || '');
        setAge(data.age?.toString() || '');
        setHeight(data.height?.toString() || '');
        setWeight(data.weight?.toString() || '');
        setState(data.state || '');
        setSleepHours(data.sleepHours?.toString() || '');
        setHealthIssuesList(data.healthIssues || []);
      } else {
        console.warn("User details not found or server error");
      }
    } catch (error) {
      console.error("Failed to fetch user details", error);
    }
  };

  fetchUserDetails();
}, [userId]);



  const renderPicker = () => (
    <>
      <TouchableOpacity
        style={[styles.pickerButton, errors.state && styles.inputError]}
        onPress={() => setModalVisible(true)}
      >
        <Text>{state || 'Select a state'}</Text>
      </TouchableOpacity>

      <Modal visible={modalVisible} transparent animationType="slide">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <FlatList
              data={indianStates}
              keyExtractor={(item, index) => index.toString()}
              renderItem={({ item }) => (
                <TouchableOpacity
                  style={styles.modalItem}
                  onPress={() => {
                    setState(item);
                    setModalVisible(false);
                  }}
                >
                  <Text>{item}</Text>
                </TouchableOpacity>
              )}
            />
            <TouchableOpacity
              onPress={() => setModalVisible(false)}
              style={{ padding: 10, alignSelf: 'center' }}
            >
              <Text style={{ color: 'red' }}>Cancel</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>
    </>
  );

  return (
    <View contentContainerStyle={styles.container}>
      {renderProgress()}

      {page === 1 && (
        <View style={styles.page}>
          <Text style={styles.label}>Name:</Text>
          <TextInput
            style={[styles.input, errors.name && styles.inputError]}
            value={name}
            onChangeText={setName}
          />
          <Text style={styles.note}>Let us know what we should call you.</Text>

          <Text style={styles.label}>Gender:</Text>
          <View style={styles.genderRow}>
            <TouchableOpacity
              style={[styles.genderBtn, gender === 'Male' && styles.selected]}
              onPress={() => setGender('Male')}
            >
              <Text>Male</Text>
            </TouchableOpacity>
            <TouchableOpacity
              style={[styles.genderBtn, gender === 'Female' && styles.selected]}
              onPress={() => setGender('Female')}
            >
              <Text>Female</Text>
            </TouchableOpacity>
          </View>
          <Text style={styles.note}>We use sex at birth and age to calculate an accurate goal for you.</Text>

          <Text style={styles.label}>Age:</Text>
          <TextInput
            style={[styles.input, errors.age && styles.inputError]}
            keyboardType='numeric'
            value={age}
            onChangeText={setAge}
          />
          <Text style={styles.note}>How old are you?</Text>
        </View>
      )}

      {page === 2 && (
        <View style={styles.page}>
          <Text style={styles.label}>Height (cm):</Text>
          <TextInput
            style={[styles.input, errors.height && styles.inputError]}
            keyboardType='numeric'
            value={height}
            onChangeText={setHeight}
          />
          <Text style={styles.note}>Knowing your height helps personalize your experience.</Text>

          <Text style={styles.label}>Weight (kg):</Text>
          <TextInput
            style={[styles.input, errors.weight && styles.inputError]}
            keyboardType='numeric'
            value={weight}
            onChangeText={setWeight}
          />
          <Text style={styles.note}>Used for BMI and calorie calculations.</Text>

          <Text style={styles.label}>Where do you live:</Text>
          <Text style={styles.note}>Choose your current location to tailor health insights.</Text>
          {renderPicker()}
        </View>
      )}

      {page === 3 && (
        <View style={styles.page}>
          <Text style={styles.label}>Sleep Hours:</Text>
          <TextInput
            style={[styles.input, errors.sleepHours && styles.inputError]}
            keyboardType='numeric'
            value={sleepHours}
            onChangeText={setSleepHours}
          />
          <Text style={styles.note}>Good sleep impacts your overall health and energy.</Text>

          <Text style={styles.label}>Health Issues:</Text>
          <Text style={styles.note}>Let us know any health issues to personalize your plan.</Text>
          <View style={styles.healthInputRow}>
            <TextInput
              style={[styles.input, { flex: 1 }]}
              value={healthIssue}
              onChangeText={setHealthIssue}
              placeholder='Enter issue'
            />
            <TouchableOpacity style={styles.addButton} onPress={addHealthIssue}>
              <Text style={{ color: 'white', fontWeight: 'bold' }}>Add</Text>
            </TouchableOpacity>
          </View>
          <FlatList
            data={healthIssuesList}
            keyExtractor={(item, index) => index.toString()}
            renderItem={({ item }) => <Text style={styles.issueItem}>{item}</Text>}
          />
        </View>
      )}

      <View style={styles.navRow}>
        {page > 1 && (
          <TouchableOpacity style={styles.backButton} onPress={prevPage}>
            <Text style={{ fontSize: 18, color:"#fff" }}>‚Üê </Text>
          </TouchableOpacity>
        )}
        <TouchableOpacity style={styles.button} onPress={handleNext}>
          <Text style={styles.buttonText}>{page < 3 ? 'Next' : 'Submit'}</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: { padding: 20, paddingTop: 50 },
  progressBar: { flexDirection: 'row', justifyContent: 'center', marginBottom: 20 },
  bar: { width: 100, height: 5, backgroundColor: '#ddd', marginHorizontal: 5, borderRadius: 5 },
  barActive: { backgroundColor: 'green' },
  page: { marginBottom: 150 },
  label: { fontSize: 20, fontWeight: 'bold', marginTop: 40 },
  note: { color: 'rgba(0, 0, 0, 0.4)', fontSize: 12, marginTop: 4 },
  input: { borderWidth: 1, borderColor: '#ccc', borderRadius: 6, padding: 10, marginTop: 10 },
  inputError: { borderColor: 'red' },
  genderRow: { flexDirection: 'row', marginTop: 10 },
  genderBtn: { padding: 10, borderWidth: 1, borderColor: '#ccc', borderRadius: 6, marginRight: 10 },
  selected: { backgroundColor: '#e0ffe0', borderColor: 'green' },
  navRow: { flexDirection: 'row', justifyContent: 'space-between', marginTop: 40 },
  button: { backgroundColor: 'green', padding: 10, borderRadius: 6, position: 'absolute', right: 0 },
  buttonText: { color: 'white', fontWeight: 'bold' },
  backButton: { justifyContent: 'center' },
  pickerButton: {
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 6,
    padding: 12,
    marginTop: 10
  },
  modalOverlay: {
    flex: 1,
    justifyContent: 'center',
    backgroundColor: 'rgba(0,0,0,0.4)'
  },
  modalContent: {
    backgroundColor: 'white',
    margin: 50,
    borderRadius: 8,
    padding: 40,
    maxHeight: '80%'
  },
  modalItem: {
    padding: 20,
    borderBottomWidth: 1,
    borderBottomColor: '#eee'
  },
  healthInputRow: { flexDirection: 'row', alignItems: 'center', marginTop: 10 },
  addButton: { backgroundColor: 'green', padding: 10, marginLeft: 10, borderRadius: 6 },
  issueItem: { padding: 5, backgroundColor: '#e6ffe6', borderRadius: 4, marginVertical: 2 }
});


// // import React from 'react';
// // import { View, ScrollView, StyleSheet, Text } from 'react-native';
// // import MealCard from './mealcard';
// // import { useRouter } from 'expo-router';
// // import imgg from '../assets/images/logo.jpg';

// // const meals = [
// //   {
// //     id: 1,
// //     name: 'Avocado Toast with Eggs',
// //     time: '8 min',
// //     calories: 250,
// //     image: imgg,
// //     macros: { carbs: 20, protein: 10, fat: 15 }
// //   },
// //   {
// //     id: 2,
// //     name: 'Pesto Chicken Penne Pasta',
// //     time: '25 min',
// //     calories: 600,
// //     image: imgg,
// //     macros: { carbs: 60, protein: 35, fat: 25 }
// //   },
// //   {
// //     id: 3,
// //     name: 'Fried Chicken Bowl',
// //     time: '40 min',
// //     calories: 750,
// //     image: imgg,
// //     macros: { carbs: 70, protein: 35, fat: 35 }
// //   }
// // ];

// // export default function Tracking() {
// //   const router = useRouter();

// //   return (
// //     <ScrollView style={styles.container}>
// //       <Text style={styles.heading}>Meal Plan</Text>
// //       {meals.map(meal => (
// //         <MealCard key={meal.id} meal={meal} router={router} />
// //       ))}
// //     </ScrollView>
// //   );
// // }

// // const styles = StyleSheet.create({
// //   container: {
// //     padding: 10,
// //     backgroundColor: '#e6d6f5'
// //   },
// //   heading: {
// //     fontSize: 26,
// //     fontWeight: 'bold',
// //     textAlign: 'center',
// //     marginVertical: 16,
// //     color: '#4a0072'
// //   }
// // });


// import React from 'react';
// import { View, ScrollView, StyleSheet, Text, TouchableOpacity } from 'react-native';
// import MealCard from './mealcard';
// import { useRouter } from 'expo-router';
// import { Ionicons } from '@expo/vector-icons'; // icon for back button
// import imgg from '../assets/images/logo.jpg';

// const meals = [
//   {
//     id: 1,
//     name: 'Avocado Toast with Eggs',
//     time: '8 min',
//     calories: 250,
//     image: imgg,
//     macros: { carbs: 20, protein: 10, fat: 15 }
//   },
//   {
//     id: 2,
//     name: 'Pesto Chicken Penne Pasta',
//     time: '25 min',
//     calories: 600,
//     image: imgg,
//     macros: { carbs: 60, protein: 35, fat: 25 }
//   },
//   {
//     id: 3,
//     name: 'Fried Chicken Bowl',
//     time: '40 min',
//     calories: 750,
//     image: imgg,
//     macros: { carbs: 70, protein: 35, fat: 35 }
//   }
// ];

// export default function Tracking() {
//   const router = useRouter();

//   return (
//     <ScrollView style={styles.container}>
//       {/* Back Button */}
//       <TouchableOpacity style={styles.backButton} onPress={() => router.back()}>
//         <Ionicons name="arrow-back" size={24} color="#4a0072" />
//         <Text style={styles.backText}>Back</Text>
//       </TouchableOpacity>

//       <Text style={styles.heading}>Meal Plan</Text>
//       {meals.map(meal => (
//         <MealCard key={meal.id} meal={meal} router={router} />
//       ))}
//     </ScrollView>
//   );
// }

// const styles = StyleSheet.create({
//   container: {
//     padding: 10,
//     backgroundColor: '#e6d6f5',
//     flex: 1,
//   },
//   heading: {
//     fontSize: 26,
//     fontWeight: 'bold',
//     textAlign: 'center',
//     marginVertical: 16,
//     color: '#4a0072'
//   },
//   backButton: {
//     flexDirection: 'row',
//     alignItems: 'center',
//     marginBottom: 10
//   },
//   backText: {
//     marginLeft: 6,
//     fontSize: 16,
//     color: '#4a0072',
//     fontWeight: 'bold'
//   }
// });





import React, { useState, useEffect, useImperativeHandle } from 'react';
import { View, ScrollView, StyleSheet, Text, TouchableOpacity, Image } from 'react-native';
import MealCard from './mealcard';
import { useRouter } from 'expo-router';
import { Ionicons } from '@expo/vector-icons';
import axios from 'axios';
import AsyncStorage from "@react-native-async-storage/async-storage";
import { useUser } from "../context/authContext"; 

export default function Tracking() {
  const router = useRouter();
  const [meals, setMeals] = useState([]);
  const [loading, setLoading] = useState(true);
  const [userId, setUserId] = useState(null);

  const fetchUserId = async () => {
    try {
      const storedId = await AsyncStorage.getItem("userId");
      if (storedId) {
        setUserId(storedId);
        console.log("Retrieved userId:", storedId);
      } else {
        console.warn("No userId found in AsyncStorage.");
      }
    } catch (error) {
      console.error("Error retrieving userId:", error);
    }
  };

  const { user } = useUser();
  useEffect(() => {
    if (user?.user?._id) {
      setUserId(user.user._id); // Set the user ID from context
    }
  }, [user]); // Run when `user` changes
  
  // useEffect(() => {
  //   fetchUserId();
  //   const fetchMeals = async () => {
  //     try {
  //       // Replace 'userId' with actual user ID from your auth system
  //       const response = await axios.get('http://192.168.132.131:5000/api/details/${userId}/meals');
  //       setMeals(response.data);
  //     } catch (error) {
  //       console.error('Error fetching meals:', error);
  //     } finally {
  //       setLoading(false);
  //     }
  //   };

  //   fetchMeals();
  // }, []);

  useEffect(() => {
    const fetchMeals = async () => {
      try {
        setLoading(true);
        console.log("sending user id to meals route from tracking",useImperativeHandle)
        const response = await fetch(`http://192.168.132.131:5000/api/details/${userId}/meals`);
        
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }
        
        const data = await response.json();
        setMeals(data);
      } catch (error) {
        console.error('Fetch error:', error);
        // Optional: Set error state
        // setError(error.message);
      } finally {
        setLoading(false);
      }
    };
  
    if (userId) fetchMeals();
  }, [userId]);

  if (loading) {
    return (
      <View style={styles.container}>
        <Text>Loading meals...</Text>
      </View>
    );
  }

  return (
    <ScrollView style={styles.container}>
      <TouchableOpacity style={styles.backButton} onPress={() => router.back()}>
        <Ionicons name="arrow-back" size={24} color="#4a0072" />
        <Text style={styles.backText}>Back</Text>
      </TouchableOpacity>

      <Text style={styles.heading}>Meal Plan</Text>
      {meals.length > 0 ? (
        meals.map(meal => (
          <MealCard key={meal.id} meal={meal} router={router} />
        ))
      ) : (
        <Text style={styles.noMealsText}>No meals tracked yet</Text>
      )}
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 16,
    backgroundColor: '#fff',
  },
  backButton: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 20,
  },
  backText: {
    marginLeft: 8,
    color: '#4a0072',
    fontSize: 16,
  },
  heading: {
    fontSize: 24,
    fontWeight: 'bold',
    marginBottom: 20,
    color: '#4a0072',
  },
  noMealsText: {
    textAlign: 'center',
    marginTop: 20,
    color: '#666',
  },
});






import React, { useState, useEffect } from "react";
import {
  View,
  Text,
  StyleSheet,
  Image,
  TouchableOpacity,
  ImageBackground,
  Platform,
  ScrollView,
  KeyboardAvoidingView,
} from "react-native";
import * as ImagePicker from "expo-image-picker";
import { useRouter } from "expo-router";
import { StatusBar } from "expo-status-bar";
import { Ionicons } from "@expo/vector-icons";
import * as Progress from "react-native-progress";
import * as FileSystem from "expo-file-system";
import AsyncStorage from "@react-native-async-storage/async-storage";


const SnapMeal = () => {
  const [image, setImage] = useState(null);
  const [submitted, setSubmitted] = useState(false);
  const [summary, setSummary] = useState("");
  const [carbs, setCarbs] = useState(0);
  const [protein, setProtein] = useState(0);
  const [fat, setFat] = useState(0);
  const maxNutrient = 100;
  const [userId, setUserId] = useState(null);


  const router = useRouter();

  useEffect(() => {
    const fetchData = async () => {
      const storedId = await AsyncStorage.getItem("userId");
      console.log('storedid from logfood',storedId)
      if (storedId) {
        console.log("User ID from logfood:", storedId);
      setUserId(storedId);
      
      }
    };
    fetchData();
  }, []);
  
  const uploadImageToBackend = async (uri) => {
    try {
      const base64 = await FileSystem.readAsStringAsync(uri, {
        encoding: FileSystem.EncodingType.Base64,
      });
      // fetchUserId();
      // console.log("user id and image are",userId);
      // const userId = new mongoose.Types.ObjectId(userId);
      // console.log("user id and image are",userId);
      console.log("user if from log-food to backend",userId);

      const response = await fetch("http://192.168.132.131:5000/api/details/upload-image", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: userId, // Replace with dynamic user ID if needed
          base64Image: base64,
        }),
      });
     
     
      const data = await response.json();
      if (!response.ok) throw new Error(data.error || "Upload failed");

      setSummary(data.food.summary || "No summary returned");

      const [totalCalories, carbsVal, proteinVal, fatVal] =
        (data.food.calorieInfo || "0, 0, 0, 0")
          .split(",")
          .map((x) => parseInt(x.trim()));

      setCarbs(carbsVal);
      setProtein(proteinVal);
      setFat(fatVal);
    } catch (err) {
      console.error("‚ùå Error uploading image:", err);
      setSummary("Failed to analyze the image. Please try again.");
    }
  };

  const pickImage = async () => {
    const permission = await ImagePicker.requestMediaLibraryPermissionsAsync();
    if (!permission.granted) {
      alert("Permission to access gallery is required!");
      return;
    }

    const result = await ImagePicker.launchImageLibraryAsync({
      allowsEditing: true,
      quality: 1,
    });

    if (!result.canceled) {
      const uri = result.assets[0].uri;
      setImage(uri);
      setSubmitted(true);
      uploadImageToBackend(uri);
    }
  };

  const captureImage = async () => {
    const permission = await ImagePicker.requestCameraPermissionsAsync();
    if (!permission.granted) {
      alert("Permission to access camera is required!");
      return;
    }

    const result = await ImagePicker.launchCameraAsync({
      allowsEditing: true,
      quality: 1,
    });

    if (!result.canceled) {
      const uri = result.assets[0].uri;
      setImage(uri);
      setSubmitted(true);
      uploadImageToBackend(uri);
    }
  };

  const goBack = () => {
    setImage(null);
    setSubmitted(false);
    setSummary("");
    setCarbs(0);
    setProtein(0);
    setFat(0);
  };

  const goToDashboard = () => {
    router.push("/dashboard");
  };
 

  
  return (
    <KeyboardAvoidingView style={{ flex: 1 }} behavior="padding" enabled>
      <ImageBackground
        source={require("../assets/images/background.jpg")}
        style={styles.backgroundd}
        resizeMode="cover"
      >
        <StatusBar style="light" />
        <View style={styles.overlay}>
          <TouchableOpacity onPress={goToDashboard} style={styles.universalBackButton}>
            <Ionicons name="home" size={24} color="#fff" />
          </TouchableOpacity>

          {submitted && (
            <TouchableOpacity onPress={goBack} style={styles.backButton}>
              <Ionicons name="arrow-back" size={24} color="#fff" />
              <Text style={styles.backText}>Back</Text>
            </TouchableOpacity>
          )}

          {!submitted ? (
            <>
              <Text style={styles.heading}>Snap Your{"\n"}Meal Before{"\n"}You Dig In</Text>
              <View style={styles.previewContainer}>
                {image ? (
                  <Image source={{ uri: image }} style={styles.previewImage} />
                ) : (
                  <View style={styles.placeholder}>
                    <Ionicons name="image-outline" size={48} color="#aaa" />
                  </View>
                )}
              </View>

              <View style={styles.buttonRow}>
                <TouchableOpacity style={styles.button} onPress={pickImage}>
                  <Ionicons name="images-outline" size={20} color="#fff" />
                  <Text style={styles.buttonText}>Upload from{"\n"}Gallery</Text>
                </TouchableOpacity>

                <TouchableOpacity style={styles.button} onPress={captureImage}>
                  <Ionicons name="camera-outline" size={20} color="#fff" />
                  <Text style={styles.buttonText}>Log{"\n"}Food</Text>
                </TouchableOpacity>
              </View>
            </>
          ) : (
            <ScrollView style={{ flex: 1 }}>
              <View style={styles.contentContainer}>
                <View style={styles.card}>
                  <Text style={styles.cardTitle}>Macronutrients</Text>
                  <View style={styles.nutrientStatsRow}>
                    <View style={styles.nutrientStat}>
                      <Text style={styles.statLabel}>Carbs</Text>
                      <Progress.Circle
                        size={80}
                        progress={carbs / maxNutrient}
                        showsText
                        formatText={() => `${carbs}g`}
                        color="#F6C445"
                        thickness={8}
                        borderWidth={0}
                        unfilledColor="#f2f2f2"
                      />
                    </View>
                    <View style={styles.nutrientStat}>
                      <Text style={styles.statLabel}>Protein</Text>
                      <Progress.Circle
                        size={80}
                        progress={protein / maxNutrient}
                        showsText
                        formatText={() => `${protein}g`}
                        color="#FF6A5C"
                        thickness={8}
                        borderWidth={0}
                        unfilledColor="#f2f2f2"
                      />
                    </View>
                    <View style={styles.nutrientStat}>
                      <Text style={styles.statLabel}>Fat</Text>
                      <Progress.Circle
                        size={80}
                        progress={fat / maxNutrient}
                        showsText
                        formatText={() => `${fat}g`}
                        color="#82B1FF"
                        thickness={8}
                        borderWidth={0}
                        unfilledColor="#f2f2f2"
                      />
                    </View>
                  </View>
                </View>

                <View style={styles.summarySection}>
                  <Text style={styles.summaryHeading}>Summary</Text>
                  <Text style={styles.summaryText}>{summary}</Text>
                </View>
              </View>
            </ScrollView>
          )}
        </View>
      </ImageBackground>
    </KeyboardAvoidingView>
  );
};




const styles = StyleSheet.create({
  backgroundd: {
    flex: 1,
    width: "100%",
    height: "100%",
  },
  overlay: {
    flex: 1,
    backgroundColor: "rgba(0,0,0,0.3)",
    padding: 20,
    justifyContent: "space-between",
    paddingBottom: 30,
  },
  heading: {
    color: "#fff",
    fontSize: 31,
    fontWeight: "bold",
    marginTop: 50,
  },
  previewContainer: {
    height: 250,
    borderRadius: 20,
    borderWidth: 2,
    borderColor: "#fff",
    justifyContent: "center",
    alignItems: "center",
    overflow: "hidden",
    backgroundColor: "#00000040",
  },
  previewImage: {
    width: "100%",
    height: "100%",
    resizeMode: "cover",
  },
  placeholder: {
    justifyContent: "center",
    alignItems: "center",
  },
  buttonRow: {
    flexDirection: "row",
    justifyContent: "space-around",
  },
  button: {
    backgroundColor: "#ff6600",
    paddingVertical: 15,
    paddingHorizontal: 20,
    borderRadius: 12,
    alignItems: "center",
    width: "45%",
  },
  buttonText: {
    color: "#fff",
    fontWeight: "bold",
    textAlign: "center",
    fontSize: 14,
    marginTop: 5,
  },
  backButton: {
    flexDirection: "row",
    alignItems: "center",
    marginTop: Platform.OS === "ios" ? 50 : 30,
    marginBottom: 10,
  },
  backText: {
    color: "#fff",
    marginLeft: 5,
    fontSize: 16,
  },
  universalBackButton: {
    position: "absolute",
    top: 40,
    left: 20,
    zIndex: 10,
  },
  card: {
    marginTop: 20,
    padding: 15,
    backgroundColor: "#fff",
    borderRadius: 10,
    shadowColor: "#000",
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 5,
  },
  cardTitle: {
    fontSize: 18,
    fontWeight: "bold",
    marginBottom: 10,
    color: "#333",
  },
  nutrientStatsRow: {
    flexDirection: "row",
    justifyContent: "space-evenly",
  },
  nutrientStat: {
    alignItems: "center",
  },
  statLabel: {
    fontSize: 14,
    marginBottom: 5,
    color: "#333",
  },
  summarySection: {
    marginTop: 30,
    padding: 15,
    backgroundColor: "#fff",
    borderRadius: 10,
    shadowColor: "#000",
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 5,
  },
  summaryHeading: {
    fontSize: 18,
    fontWeight: "bold",
    marginBottom: 10,
    color: "#333",
  },
  summaryText: {
    fontSize: 14,
    color: "#555",
  },
});

export default SnapMeal;
